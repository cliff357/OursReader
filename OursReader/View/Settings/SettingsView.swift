import SwiftUI
import UserNotifications

struct SettingsView: View {
    @StateObject private var viewModel = SettingsViewModel()
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        NavigationView {
            ZStack {
                ColorManager.shared.background
                    .ignoresSafeArea()
                
                ScrollView {
                    VStack(spacing: 20) {
                        // Â∏≥Êà∂Ë®≠ÁΩÆ
                        SettingsSectionView(title: "account_settings") {
                            VStack(spacing: 12) {
                                SettingsRowView(
                                    icon: "person.circle.fill",
                                    title: "user_profile",
                                    value: viewModel.userName,
                                    color: ColorManager.shared.red1
                                )
                                
                                SettingsRowView(
                                    icon: "envelope.fill",
                                    title: "email_address",
                                    value: viewModel.userEmail,
                                    color: .blue
                                )
                            }
                        }
                        
                        // Èñ±ËÆÄË®≠ÁΩÆ
                        SettingsSectionView(title: "reading_settings") {
                            VStack(spacing: 12) {
                                SettingsSliderRow(
                                    icon: "textformat.size",
                                    title: "font_size",
                                    value: $viewModel.fontSize,
                                    range: 12...24,
                                    color: ColorManager.shared.green1
                                )
                                .onChange(of: viewModel.fontSize) { oldValue, newValue in
                                    viewModel.saveFontSize(newValue)
                                }
                                
                                SettingsPickerRow(
                                    icon: "text.justify.left",
                                    title: "font_family",
                                    selection: $viewModel.selectedFont,
                                    options: viewModel.availableFonts,
                                    color: .orange
                                )
                                .onChange(of: viewModel.selectedFont) { oldValue, newValue in
                                    viewModel.saveFontFamily(newValue)
                                }
                                
                                // Â≠óÈ´îÈ†êË¶ΩÂçÄÂüü
                                VStack(alignment: .leading, spacing: 8) {
                                    Text("font_preview")
                                        .font(.caption)
                                        .foregroundColor(.gray)
                                    
                                    Text("Hello, World! ‰Ω†Â•ΩÔºå‰∏ñÁïåÔºÅ")
                                        .font(.system(size: viewModel.fontSize))
                                        .fontDesign(viewModel.fontDesign)
                                        .foregroundColor(.black)
                                        .padding()
                                        .frame(maxWidth: .infinity, alignment: .leading)
                                        .background(Color.white)
                                        .cornerRadius(8)
                                }
                                .padding(.horizontal)
                            }
                        }
                        
                        // üîß ‰øÆÊîπÔºöË™ûË®ÄË®≠ÁΩÆ - ‰ΩøÁî® LM ÊûöËàâ
                        SettingsSectionView(title: "language_settings") {
                            SettingsPickerRow(
                                icon: "globe",
                                title: "app_language",
                                selection: $viewModel.selectedLanguage,
                                options: viewModel.availableLanguages,
                                color: .blue
                            )
                            .onChange(of: viewModel.selectedLanguage) { oldValue, newValue in
                                viewModel.changeLanguage(newValue)
                            }
                        }
                        
                        // ÈÄöÁü•Ë®≠ÁΩÆ
                        SettingsSectionView(title: "notification_settings") {
                            VStack(spacing: 12) {
                                SettingsToggleRow(
                                    icon: "bell.fill",
                                    title: "enable_notifications",
                                    isOn: $viewModel.notificationsEnabled,
                                    color: .red
                                )
                                .onChange(of: viewModel.notificationsEnabled) { oldValue, newValue in
                                    viewModel.toggleNotifications(newValue)
                                }
                                
                                if viewModel.notificationsEnabled {
                                    SettingsToggleRow(
                                        icon: "book.fill",
                                        title: "reading_reminders",
                                        isOn: $viewModel.readingReminders,
                                        color: ColorManager.shared.red1
                                    )
                                }
                            }
                        }
                        
                        // ÂÑ≤Â≠òÁ©∫Èñì
                        SettingsSectionView(title: "storage_management") {
                            VStack(spacing: 12) {
                                VStack(spacing: 8) {
                                    // üîß ‰øÆÊîπÔºöÈ°ØÁ§∫Â∑≤‰ΩøÁî®ÂíåÂâ©È§òÁ©∫Èñì
                                    SettingsRowView(
                                        icon: "icloud.fill",
                                        title: "icloud_storage",
                                        value: viewModel.iCloudStorageDisplay,
                                        color: .blue
                                    )
                                    
                                    // Ë©≥Á¥∞Áµ±Ë®à
                                    if viewModel.isLoadingStorage {
                                        HStack {
                                            ProgressView()
                                                .scaleEffect(0.8)
                                            Text("storage_calculating")
                                                .font(.caption)
                                                .foregroundColor(.gray)
                                        }
                                        .padding(.horizontal)
                                    } else if let stats = viewModel.storageStats {
                                        VStack(alignment: .leading, spacing: 6) {
                                            StorageStatRow(
                                                label: "storage_books_count",
                                                value: "\(stats.booksCount)",
                                                icon: "book.fill",
                                                color: ColorManager.shared.red1
                                            )
                                            
                                            StorageStatRow(
                                                label: "storage_total_size",
                                                value: stats.totalSizeFormatted,
                                                icon: "externaldrive.fill",
                                                color: .blue
                                            )
                                            
                                            StorageStatRow(
                                                label: "storage_avg_book_size",
                                                value: stats.averageSizeFormatted,
                                                icon: "chart.bar.fill",
                                                color: ColorManager.shared.green1
                                            )
                                            
                                            // üîß Êñ∞Â¢ûÔºöÂâ©È§òÁ©∫Èñì
                                            if let remaining = viewModel.remainingStorage {
                                                StorageStatRow(
                                                    label: "storage_remaining",
                                                    value: remaining,
                                                    icon: "circle.dashed",
                                                    color: .orange
                                                )
                                            }
                                        }
                                        .padding(.horizontal)
                                        .padding(.vertical, 8)
                                        .background(Color.blue.opacity(0.05))
                                        .cornerRadius(8)
                                        .padding(.horizontal)
                                    }
                                    
                                    // ÈáçÊñ∞Êï¥ÁêÜÊåâÈàï
                                    Button(action: {
                                        viewModel.refreshStorageUsage()
                                    }) {
                                        HStack {
                                            Image(systemName: "arrow.clockwise")
                                                .foregroundColor(.blue)
                                            Text("storage_refresh")
                                                .foregroundColor(.black)
                                            Spacer()
                                            if viewModel.isLoadingStorage {
                                                ProgressView()
                                                    .scaleEffect(0.8)
                                            }
                                        }
                                        .padding()
                                        .background(Color.white)
                                        .cornerRadius(10)
                                    }
                                    .disabled(viewModel.isLoadingStorage)
                                }
                                
                                // üîß ÁßªÈô§Ê∏ÖÈô§Á∑©Â≠òÊåâÈàï
                            }
                        }
                        
                        // ÈóúÊñº
                        SettingsSectionView(title: "about_app") {
                            VStack(spacing: 12) {
                                SettingsRowView(
                                    icon: "info.circle.fill",
                                    title: "app_version",
                                    value: viewModel.appVersion,
                                    color: .gray
                                )
                                
                                // üîß ÁßªÈô§Èö±ÁßÅÊîøÁ≠ñÂíåÊúçÂãôÊ¢ùÊ¨æ
                            }
                        }
                        
                        // ÁôªÂá∫ÊåâÈàï
                        Button(action: {
                            viewModel.showLogoutAlert = true
                        }) {
                            HStack {
                                Image(systemName: "rectangle.portrait.and.arrow.right")
                                Text(String(localized: "auth_logout_button"))
                            }
                            .foregroundColor(.white)
                            .padding()
                            .frame(maxWidth: .infinity)
                            .background(Color.red)
                            .cornerRadius(10)
                        }
                        .padding(.top, 20)
                    }
                    .padding()
                }
            }
            .navigationTitle(String(localized: "settings"))
            .navigationBarTitleDisplayMode(.large)
            .alert(String(localized: "confirm_logout"), isPresented: $viewModel.showLogoutAlert) {
                Button(String(localized: "general_cancel"), role: .cancel) {}
                Button(String(localized: "auth_logout_button"), role: .destructive) {
                    NotificationCenter.default.post(
                        name: NSNotification.Name("userDidLogout"),
                        object: nil
                    )
                    UserAuthModel.shared.signOut()
                    dismiss()
                }
            } message: {
                Text(String(localized: "logout_confirmation_message"))
            }
            .onAppear {
                viewModel.checkNotificationPermission()
            }
        }
        // üîß ‰øÆÊîπÔºöÂè™Âú® SettingsView ÂÖßÈÉ®ÈáçÊñ∞Ê∏≤ÊüìÔºå‰∏çÂΩ±ÈüøÂ∞éËà™
        .id(viewModel.languageChangeID)
    }
}

// MARK: - Settings Section View
struct SettingsSectionView<Content: View>: View {
    let title: String
    let content: Content
    
    init(title: String, @ViewBuilder content: () -> Content) {
        self.title = title
        self.content = content()
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
            Text(title.localized)
                .font(.headline)
                .foregroundColor(.black)
                .padding(.horizontal)
            
            VStack(spacing: 0) {
                content
            }
            .background(Color.white)
            .cornerRadius(12)
        }
    }
}

// MARK: - Settings Row View
struct SettingsRowView: View {
    let icon: String
    let title: String
    let value: String?
    let color: Color
    let action: (() -> Void)?
    
    init(
        icon: String,
        title: String,
        value: String? = nil,
        color: Color,
        action: (() -> Void)? = nil
    ) {
        self.icon = icon
        self.title = title
        self.value = value
        self.color = color
        self.action = action
    }
    
    var body: some View {
        Button(action: { action?() }) {
            HStack {
                Image(systemName: icon)
                    .foregroundColor(color)
                    .frame(width: 30)
                
                // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
                Text(title.localized)
                    .foregroundColor(.black)
                
                Spacer()
                
                if let value = value {
                    Text(value)
                        .foregroundColor(.gray)
                }
                
                if action != nil {
                    Image(systemName: "chevron.right")
                        .foregroundColor(.gray)
                        .font(.caption)
                }
            }
            .padding()
        }
        .disabled(action == nil)
    }
}

// MARK: - Settings Toggle Row
struct SettingsToggleRow: View {
    let icon: String
    let title: String
    @Binding var isOn: Bool
    let color: Color
    
    var body: some View {
        HStack {
            Image(systemName: icon)
                .foregroundColor(color)
                .frame(width: 30)
            
            // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
            Text(title.localized)
                .foregroundColor(.black)
            
            Spacer()
            
            Toggle("", isOn: $isOn)
                .labelsHidden()
        }
        .padding()
    }
}

// MARK: - Settings Slider Row
struct SettingsSliderRow: View {
    let icon: String
    let title: String
    @Binding var value: Double
    let range: ClosedRange<Double>
    let color: Color
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Image(systemName: icon)
                    .foregroundColor(color)
                    .frame(width: 30)
                
                // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
                Text(title.localized)
                    .foregroundColor(.black)
                
                Spacer()
                
                Text("\(Int(value))")
                    .foregroundColor(.gray)
                    .monospacedDigit()
            }
            
            Slider(value: $value, in: range, step: 1)
                .tint(color)
        }
        .padding()
    }
}

// MARK: - Settings Picker Row
struct SettingsPickerRow: View {
    let icon: String
    let title: String
    @Binding var selection: String
    let options: [String]
    let color: Color
    
    var body: some View {
        HStack {
            Image(systemName: icon)
                .foregroundColor(color)
                .frame(width: 30)
            
            // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
            Text(title.localized)
                .foregroundColor(.black)
            
            Spacer()
            
            Picker("", selection: $selection) {
                ForEach(options, id: \.self) { option in
                    Text(option).tag(option)
                }
            }
            .pickerStyle(MenuPickerStyle())
        }
        .padding()
    }
}

// MARK: - Settings Navigation Row
struct SettingsNavigationRow: View {
    let icon: String
    let title: String
    let color: Color
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            HStack {
                Image(systemName: icon)
                    .foregroundColor(color)
                    .frame(width: 30)
                
                // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
                Text(title.localized)
                    .foregroundColor(.black)
                
                Spacer()
                
                Image(systemName: "chevron.right")
                    .foregroundColor(.gray)
                    .font(.caption)
            }
            .padding()
        }
    }
}

// MARK: - Settings ViewModel
class SettingsViewModel: ObservableObject {
    @Published var userName: String = ""
    @Published var userEmail: String = ""
    @Published var fontSize: Double = 16
    @Published var selectedFont: String = "System"
    @Published var notificationsEnabled: Bool = false
    @Published var readingReminders: Bool = true
    @Published var iCloudStorageUsed: String = "storage_calculating..."
    @Published var showLogoutAlert: Bool = false
    @Published var isLoadingStorage = false
    @Published var storageStats: StorageStatistics?
    
    // üîß ‰øÆÊîπÔºöË™ûË®ÄË®≠ÁΩÆ - ‰ΩøÁî® LM.AppLanguage
    @Published var selectedLanguage: String = ""
    @Published var languageChangeID = UUID() // üîß Êñ∞Â¢ûÔºöÁî®ÊñºÂº∑Âà∂ÈáçÊñ∞Ê∏≤Êüì
    
    var availableLanguages: [String] {
        return ["English", "ÁπÅÈ´î‰∏≠Êñá", "Á∞°È´î‰∏≠Êñá"]
    }
    
    // üîß Êñ∞Â¢ûÔºöÂâ©È§òÁ©∫Èñì
    @Published var remainingStorage: String?
    
    let availableFonts = ["System", "Rounded", "Serif", "Monospaced"]
    
    // üîß Êñ∞Â¢ûÔºöÈ°ØÁ§∫Ê†ºÂºèÂåñÁöÑÂÑ≤Â≠òÁ©∫ÈñìË≥áË®ä
    var iCloudStorageDisplay: String {
        if let stats = storageStats, let remaining = remainingStorage {
            return "\(stats.totalSizeFormatted) / \(remaining)"
        }
        return iCloudStorageUsed
    }
    
    // üîß Êñ∞Â¢ûÔºöÊ†πÊìöÈÅ∏ÊìáÁöÑÂ≠óÈ´îËøîÂõûÂ∞çÊáâÁöÑ Font.Design
    var fontDesign: Font.Design {
        switch selectedFont {
        case "Rounded":
            return .rounded
        case "Serif":
            return .serif
        case "Monospaced":
            return .monospaced
        default:
            return .default
        }
    }
    
    var appVersion: String {
        if let version = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String,
           let build = Bundle.main.infoDictionary?["CFBundleVersion"] as? String {
            return "v\(version) (\(build))"
        }
        return String(localized: "version_unavailable")
    }
    
    init() {
        loadUserInfo()
        loadSettings()
        refreshStorageUsage()
        checkNotificationPermission()
        loadCurrentLanguage()
    }
    
    private func loadUserInfo() {
        if let user = UserAuthModel.shared.getCurrentFirebaseUser() {
            userEmail = user.email ?? ""
            userName = user.displayName ?? user.email ?? ""
        }
    }
    
    private func loadSettings() {
        fontSize = UserDefaults.standard.double(forKey: "fontSize")
        if fontSize == 0 { fontSize = 16 }
        selectedFont = UserDefaults.standard.string(forKey: "selectedFont") ?? "System"
        notificationsEnabled = UserDefaults.standard.bool(forKey: "notificationsEnabled")
        readingReminders = UserDefaults.standard.bool(forKey: "readingReminders")
    }
    
    // üîß Êñ∞Â¢ûÔºö‰øùÂ≠òÂ≠óÈ´îÂ§ßÂ∞èÂà∞ UserDefaults ‰∏¶ÁôºÈÄÅÈÄöÁü•
    func saveFontSize(_ size: Double) {
        UserDefaults.standard.set(size, forKey: "fontSize")
        NotificationCenter.default.post(
            name: NSNotification.Name("FontSizeDidChange"),
            object: nil,
            userInfo: ["fontSize": size]
        )
    }
    
    // üîß Êñ∞Â¢ûÔºö‰øùÂ≠òÂ≠óÈ´îÊ®£ÂºèÂà∞ UserDefaults ‰∏¶ÁôºÈÄÅÈÄöÁü•
    func saveFontFamily(_ family: String) {
        UserDefaults.standard.set(family, forKey: "selectedFont")
        NotificationCenter.default.post(
            name: NSNotification.Name("FontFamilyDidChange"),
            object: nil,
            userInfo: ["fontFamily": family]
        )
    }
    
    // üîß Êñ∞Â¢ûÔºöÊ™¢Êü•ÈÄöÁü•Ê¨äÈôê
    func checkNotificationPermission() {
        UNUserNotificationCenter.current().getNotificationSettings { settings in
            DispatchQueue.main.async {
                self.notificationsEnabled = settings.authorizationStatus == .authorized
            }
        }
    }
    
    // üîß Êñ∞Â¢ûÔºöÂàáÊèõÈÄöÁü•
    func toggleNotifications(_ enabled: Bool) {
        if enabled {
            // Ë´ãÊ±ÇÈÄöÁü•Ê¨äÈôê
            UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error in
                DispatchQueue.main.async {
                    self.notificationsEnabled = granted
                    if let error = error {
                        print("ÈÄöÁü•ÊéàÊ¨äÂ§±Êïó: \(error)")
                    }
                }
            }
        } else {
            // ÊèêÁ§∫Áî®Êà∂Âà∞Ë®≠ÁΩÆ‰∏≠ÈóúÈñâ
            if let url = URL(string: UIApplication.openSettingsURLString) {
                UIApplication.shared.open(url)
            }
        }
    }
    
    // üîß Êñ∞Â¢ûÔºöËºâÂÖ•Áï∂ÂâçË™ûË®Ä
    private func loadCurrentLanguage() {
        switch LM.currentLanguage {
        case .english:
            selectedLanguage = "English"
        case .traditionalChinese:
            selectedLanguage = "ÁπÅÈ´î‰∏≠Êñá"
        case .simplifiedChinese:
            selectedLanguage = "Á∞°È´î‰∏≠Êñá"
        }
    }
    
    // üîß ‰øÆÊîπÔºöÂç≥ÊôÇÊõ¥ÊîπË™ûË®Ä - Âè™ÈáçÊñ∞Ê∏≤ÊüìÁï∂ÂâçË¶ñÂúñ
    func changeLanguage(_ language: String) {
        let newLanguage: LM.AppLanguage
        
        switch language {
        case "English":
            newLanguage = .english
        case "Á∞°È´î‰∏≠Êñá":
            newLanguage = .simplifiedChinese
        default: // "ÁπÅÈ´î‰∏≠Êñá"
            newLanguage = .traditionalChinese
        }
        
        // üîß ÈóúÈçµÔºöÂÖàÊõ¥Êñ∞Ë™ûË®Ä
        LM.currentLanguage = newLanguage
        
        // üîß ‰øÆÊîπÔºöÂè™Êõ¥Êñ∞Áï∂ÂâçË¶ñÂúñÔºåÂª∂ÈÅ≤‰∏ÄÈªûÈªûÁ¢∫‰øùË™ûË®ÄË®≠ÁΩÆÂ∑≤ÁîüÊïà
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
            withAnimation(.easeInOut(duration: 0.3)) {
                self.languageChangeID = UUID()
            }
        }
    }
    
    // üîß ‰øÆÊîπÔºöÈáçÊñ∞Êï¥ÁêÜÂÑ≤Â≠ò‰ΩøÁî®ÈáèÔºåÂåÖÂê´Ë®àÁÆóÂâ©È§òÁ©∫Èñì
    func refreshStorageUsage() {
        guard let currentUser = UserAuthModel.shared.getCurrentFirebaseUser() else {
            iCloudStorageUsed = "storage_not_signed_in"
            return
        }
        
        isLoadingStorage = true
        
        CloudKitManager.shared.fetchStorageStatistics(firebaseUserID: currentUser.uid) { [weak self] result in
            DispatchQueue.main.async {
                self?.isLoadingStorage = false
                
                switch result {
                case .success(let stats):
                    self?.storageStats = stats
                    self?.iCloudStorageUsed = stats.totalSizeFormatted
                    
                    // üîß Êñ∞Â¢ûÔºöË®àÁÆóÂâ©È§òÁ©∫ÈñìÔºàÂÅáË®≠ iCloud ÂÖçË≤ªÊñπÊ°à 5GBÔºâ
                    let totalQuota: Int64 = 5 * 1024 * 1024 * 1024 // 5GB
                    let remaining = totalQuota - stats.totalSize
                    self?.remainingStorage = ByteCountFormatter.string(fromByteCount: remaining, countStyle: .file)
                    
                case .failure(let error):
                    print("Áç≤ÂèñÂÑ≤Â≠òÁµ±Ë®àÂ§±Êïó: \(error.localizedDescription)")
                    self?.iCloudStorageUsed = "storage_error"
                }
            }
        }
    }
}

// üîß Êñ∞Â¢ûÔºöÂÑ≤Â≠òÁµ±Ë®àÊï∏ÊìöÁµêÊßã
struct StorageStatistics {
    let booksCount: Int
    let totalSize: Int64
    let averageSize: Int64
    
    var totalSizeFormatted: String {
        ByteCountFormatter.string(fromByteCount: totalSize, countStyle: .file)
    }
    
    var averageSizeFormatted: String {
        ByteCountFormatter.string(fromByteCount: averageSize, countStyle: .file)
    }
}

// MARK: - üîß Êñ∞Â¢ûÔºöÂÑ≤Â≠òÁµ±Ë®àË°åÁµÑ‰ª∂
struct StorageStatRow: View {
    let label: String
    let value: String
    let icon: String
    let color: Color
    
    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: icon)
                .font(.caption)
                .foregroundColor(color)
                .frame(width: 20)
            
            // üîß ‰øÆÊîπÔºö‰ΩøÁî® LM.localized
            Text(label.localized)
                .font(.caption)
                .foregroundColor(.black)
            
            Spacer()
            
            Text(value)
                .font(.caption)
                .fontWeight(.medium)
                .foregroundColor(.black)
        }
    }
}

#Preview {
    SettingsView()
}
